<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>流式响应测试 - SQLBot</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; }
        .test-section { background: white; padding: 20px; margin: 20px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .test-btn { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .test-btn:hover { background: #0056b3; }
        .result { margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 5px; border-left: 4px solid #007bff; }
        .back-link { display: inline-block; padding: 10px 20px; background: #6c757d; color: white; text-decoration: none; border-radius: 5px; margin-bottom: 20px; }
        input { width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px; }
        label { display: block; margin: 10px 0 5px 0; font-weight: bold; }
        .output-area { background: #f8f9fa; border: 1px solid #ddd; border-radius: 5px; padding: 15px; max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 14px; }
        .status-indicator { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 10px; }
        .status-indicator.online { background: #28a745; }
        .status-indicator.offline { background: #dc3545; }
    </style>
</head>
<body>
    <div class="container">
        <a href="/" class="back-link">← 返回首页</a>
        <h1>🌊 流式响应测试</h1>
        <p>测试SSE流式响应功能</p>
        
        <div class="test-section">
            <h3>💬 流式聊天测试</h3>
            <p>测试实时流式聊天响应，观察SSE消息流</p>
            
            <label>数据源ID: <input type="number" id="streamChatDbId" value="1"></label>
            <label>问题: <input type="text" id="streamChatQuestion" value="查询用户数据"></label>
            <button class="test-btn" onclick="startStreamChat()">开始流式聊天</button>
            <button class="test-btn" onclick="stopStreamChat()">停止聊天</button>
            
            <div class="stream-output">
                <h4>实时输出:</h4>
                <div id="streamChatOutput" class="output-area">等待开始...</div>
            </div>
        </div>
        
        <div class="test-section">
            <h3>💡 流式推荐测试</h3>
            <p>测试实时流式推荐响应，观察SSE消息流</p>
            
            <label>聊天记录ID: <input type="number" id="streamRecommendChatId" value="123"></label>
            <button class="test-btn" onclick="startStreamRecommend()">开始流式推荐</button>
            <button class="test-btn" onclick="stopStreamRecommend()">停止推荐</button>
            
            <div class="stream-output">
                <h4>实时输出:</h4>
                <div id="streamRecommendOutput" class="output-area">等待开始...</div>
            </div>
        </div>
        
        <div class="test-section">
            <h3>📊 SSE连接状态</h3>
            <div id="connectionStatus">
                <span class="status-indicator offline"></span>
                <span>未连接</span>
            </div>
        </div>
    </div>
    
    <script>
        let chatEventSource = null;
        let recommendEventSource = null;
        
        function updateConnectionStatus(connected, type) {
            const statusIndicator = document.querySelector('.status-indicator');
            const statusText = document.querySelector('#connectionStatus span:last-child');
            
            if (connected) {
                statusIndicator.className = 'status-indicator online';
                statusText.textContent = `${type} 已连接`;
            } else {
                statusIndicator.className = 'status-indicator offline';
                statusText.textContent = '未连接';
            }
        }
        
        function startStreamChat() {
            const dbId = document.getElementById('streamChatDbId').value;
            const question = document.getElementById('streamChatQuestion').value;
            const output = document.getElementById('streamChatOutput');
            
            output.innerHTML = '';
            
            try {
                const response = fetch('/api/test/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ dbId: parseInt(dbId), question, chatId: 'stream_test_' + Date.now() })
                });
                
                output.innerHTML = '<div class="message info">✅ 流式聊天请求已发送</div>';
                updateConnectionStatus(true, '聊天');
                
            } catch (error) {
                output.innerHTML = '<div class="message error">❌ 错误: ' + error.message + '</div>';
                updateConnectionStatus(false);
            }
        }
        
        function stopStreamChat() {
            if (chatEventSource) {
                chatEventSource.close();
                chatEventSource = null;
            }
            updateConnectionStatus(false);
            document.getElementById('streamChatOutput').innerHTML += '<div class="message info">聊天连接已关闭</div>';
        }
        
        function startStreamRecommend() {
            const chatRecordId = document.getElementById('streamRecommendChatId').value;
            const output = document.getElementById('streamRecommendOutput');
            
            output.innerHTML = '';
            
            try {
                const response = fetch('/api/test/recommend', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ chatRecordId: parseInt(chatRecordId) })
                });
                
                output.innerHTML = '<div class="message info">✅ 流式推荐请求已发送</div>';
                updateConnectionStatus(true, '推荐');
                
            } catch (error) {
                output.innerHTML = '<div class="message error">❌ 错误: ' + error.message + '</div>';
                updateConnectionStatus(false);
            }
        }
        
        function stopStreamRecommend() {
            if (recommendEventSource) {
                recommendEventSource.close();
                recommendEventSource = null;
            }
            updateConnectionStatus(false);
            document.getElementById('streamRecommendOutput').innerHTML += '<div class="message info">推荐连接已关闭</div>';
        }
        
        window.addEventListener('beforeunload', function() {
            if (chatEventSource) chatEventSource.close();
            if (recommendEventSource) recommendEventSource.close();
        });
    </script>
</body>
</html>