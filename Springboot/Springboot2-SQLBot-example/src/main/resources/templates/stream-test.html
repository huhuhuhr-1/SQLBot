<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æµå¼å“åº”æµ‹è¯• - SQLBot</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; }
        .test-section { background: white; padding: 20px; margin: 20px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .test-btn { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .test-btn:hover { background: #0056b3; }
        .result { margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 5px; border-left: 4px solid #007bff; }
        .back-link { display: inline-block; padding: 10px 20px; background: #6c757d; color: white; text-decoration: none; border-radius: 5px; margin-bottom: 20px; }
        input { width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px; }
        label { display: block; margin: 10px 0 5px 0; font-weight: bold; }
        .output-area { background: #f8f9fa; border: 1px solid #ddd; border-radius: 5px; padding: 15px; max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 14px; }
        .status-indicator { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 10px; }
        .status-indicator.online { background: #28a745; }
        .status-indicator.offline { background: #dc3545; }
    </style>
</head>
<body>
    <div class="container">
        <a href="/" class="back-link">â† è¿”å›é¦–é¡µ</a>
        <h1>ğŸŒŠ æµå¼å“åº”æµ‹è¯•</h1>
        <p>æµ‹è¯•SSEæµå¼å“åº”åŠŸèƒ½</p>
        
        <div class="test-section">
            <h3>ğŸ’¬ æµå¼èŠå¤©æµ‹è¯•</h3>
            <p>æµ‹è¯•å®æ—¶æµå¼èŠå¤©å“åº”ï¼Œè§‚å¯ŸSSEæ¶ˆæ¯æµ</p>
            
            <label>æ•°æ®æºID: <input type="number" id="streamChatDbId" value="1"></label>
            <label>é—®é¢˜: <input type="text" id="streamChatQuestion" value="æŸ¥è¯¢ç”¨æˆ·æ•°æ®"></label>
            <button class="test-btn" onclick="startStreamChat()">å¼€å§‹æµå¼èŠå¤©</button>
            <button class="test-btn" onclick="stopStreamChat()">åœæ­¢èŠå¤©</button>
            
            <div class="stream-output">
                <h4>å®æ—¶è¾“å‡º:</h4>
                <div id="streamChatOutput" class="output-area">ç­‰å¾…å¼€å§‹...</div>
            </div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ’¡ æµå¼æ¨èæµ‹è¯•</h3>
            <p>æµ‹è¯•å®æ—¶æµå¼æ¨èå“åº”ï¼Œè§‚å¯ŸSSEæ¶ˆæ¯æµ</p>
            
            <label>èŠå¤©è®°å½•ID: <input type="number" id="streamRecommendChatId" value="123"></label>
            <button class="test-btn" onclick="startStreamRecommend()">å¼€å§‹æµå¼æ¨è</button>
            <button class="test-btn" onclick="stopStreamRecommend()">åœæ­¢æ¨è</button>
            
            <div class="stream-output">
                <h4>å®æ—¶è¾“å‡º:</h4>
                <div id="streamRecommendOutput" class="output-area">ç­‰å¾…å¼€å§‹...</div>
            </div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ“Š SSEè¿æ¥çŠ¶æ€</h3>
            <div id="connectionStatus">
                <span class="status-indicator offline"></span>
                <span>æœªè¿æ¥</span>
            </div>
        </div>
    </div>
    
    <script>
        let chatEventSource = null;
        let recommendEventSource = null;
        
        function updateConnectionStatus(connected, type) {
            const statusIndicator = document.querySelector('.status-indicator');
            const statusText = document.querySelector('#connectionStatus span:last-child');
            
            if (connected) {
                statusIndicator.className = 'status-indicator online';
                statusText.textContent = `${type} å·²è¿æ¥`;
            } else {
                statusIndicator.className = 'status-indicator offline';
                statusText.textContent = 'æœªè¿æ¥';
            }
        }
        
        function startStreamChat() {
            const dbId = document.getElementById('streamChatDbId').value;
            const question = document.getElementById('streamChatQuestion').value;
            const output = document.getElementById('streamChatOutput');
            
            output.innerHTML = '';
            
            try {
                const response = fetch('/api/test/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ dbId: parseInt(dbId), question, chatId: 'stream_test_' + Date.now() })
                });
                
                output.innerHTML = '<div class="message info">âœ… æµå¼èŠå¤©è¯·æ±‚å·²å‘é€</div>';
                updateConnectionStatus(true, 'èŠå¤©');
                
            } catch (error) {
                output.innerHTML = '<div class="message error">âŒ é”™è¯¯: ' + error.message + '</div>';
                updateConnectionStatus(false);
            }
        }
        
        function stopStreamChat() {
            if (chatEventSource) {
                chatEventSource.close();
                chatEventSource = null;
            }
            updateConnectionStatus(false);
            document.getElementById('streamChatOutput').innerHTML += '<div class="message info">èŠå¤©è¿æ¥å·²å…³é—­</div>';
        }
        
        function startStreamRecommend() {
            const chatRecordId = document.getElementById('streamRecommendChatId').value;
            const output = document.getElementById('streamRecommendOutput');
            
            output.innerHTML = '';
            
            try {
                const response = fetch('/api/test/recommend', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ chatRecordId: parseInt(chatRecordId) })
                });
                
                output.innerHTML = '<div class="message info">âœ… æµå¼æ¨èè¯·æ±‚å·²å‘é€</div>';
                updateConnectionStatus(true, 'æ¨è');
                
            } catch (error) {
                output.innerHTML = '<div class="message error">âŒ é”™è¯¯: ' + error.message + '</div>';
                updateConnectionStatus(false);
            }
        }
        
        function stopStreamRecommend() {
            if (recommendEventSource) {
                recommendEventSource.close();
                recommendEventSource = null;
            }
            updateConnectionStatus(false);
            document.getElementById('streamRecommendOutput').innerHTML += '<div class="message info">æ¨èè¿æ¥å·²å…³é—­</div>';
        }
        
        window.addEventListener('beforeunload', function() {
            if (chatEventSource) chatEventSource.close();
            if (recommendEventSource) recommendEventSource.close();
        });
    </script>
</body>
</html>